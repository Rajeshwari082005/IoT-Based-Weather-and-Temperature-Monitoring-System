#include <ESP8266WiFi.h>
#include <ThingSpeak.h>
#include "DHT.h"

#define DHTPIN 2        // D4 pin on NodeMCU
#define DHTTYPE DHT11   // or DHT22
DHT dht(DHTPIN, DHTTYPE);

const char* ssid = "YOUR_WIFI_NAME";       // WiFi SSID
const char* password = "YOUR_WIFI_PASS";   // WiFi Password

WiFiClient client;

// ThingSpeak details
unsigned long channelID = YOUR_CHANNEL_ID;
const char * writeAPIKey = "YOUR_API_KEY";

void setup() {
  Serial.begin(115200);
  dht.begin();

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("Connected!");
  ThingSpeak.begin(client);
}

void loop() {
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  if (isnan(temperature) || isnan(humidity)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  Serial.print("Temp: "); Serial.print(temperature);
  Serial.print("Â°C  Hum: "); Serial.print(humidity);
  Serial.println("%");

  // Upload to ThingSpeak
  ThingSpeak.setField(1, temperature);
  ThingSpeak.setField(2, humidity);
  int status = ThingSpeak.writeFields(channelID, writeAPIKey);

  if (status == 200) {
    Serial.println("Data sent successfully!");
  } else {
    Serial.println("Problem uploading data. HTTP error code: " + String(status));
  }

  delay(20000); // ThingSpeak requires 15 sec delay
}
